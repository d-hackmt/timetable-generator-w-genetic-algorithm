{% extends "layout.html" %}

{% block title %}Student Access - TimetableGen{% endblock %}

{% block breadcrumb %}
<a href="/" style="text-decoration: none; color: var(--text-muted);">Home</a>
<span style="color: var(--text-muted); margin: 0 0.5rem;">/</span>
<span style="color: var(--text-main); font-weight: 600;">Student Access</span>
{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto;">
    <div style="text-align: center; margin-bottom: 3rem;">
        <h1 style="font-family: 'Outfit', sans-serif; font-weight: 700; margin-bottom: 0.5rem;">View Your Timetable ðŸ“…
        </h1>
        <p style="color: var(--text-muted);">Enter your school details below to access the latest schedule.</p>
    </div>

    <!-- Selection Form -->
    <div class="card">
        <form id="viewTimetableForm" style="display: flex; flex-direction: column; gap: 1rem;">
            <div class="grid grid-cols-1">
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="username">School Name</label>
                    <select id="username" name="username" required>
                        <option value="">Select your school...</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-2">
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="class_name">Class Name</label>
                    <select id="class_name" name="class_name" required disabled>
                        <option value="">Choose Class...</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="semester">Semester</label>
                    <select id="semester" name="semester" required disabled>
                        <option value="">Choose Sem...</option>
                    </select>
                </div>
            </div>

            <button type="submit" class="btn btn-primary" style="margin-top: 1rem; padding: 1rem;" id="findBtn"
                disabled>
                <i class="fas fa-search"></i> Find My Timetable
            </button>
        </form>
    </div>

    <!-- Timetable Display -->
    <div id="timetableContainer" style="display: none; margin-top: 3rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 id="resultTitle" style="font-family: 'Outfit', sans-serif;">Schedule</h3>
            <button onclick="window.print()" class="btn btn-secondary">
                <i class="fas fa-print"></i> Print
            </button>
        </div>

        <div class="card" style="padding: 0; overflow: hidden; border: 2px solid var(--border);">
            <div class="table-container" style="border: none; border-radius: 0; margin-top: 0;">
                <table style="border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th
                                style="background: var(--bg-main); width: 100px; border-right: 2px solid var(--border);">
                                Time</th>
                            <th>Mon</th>
                            <th>Tue</th>
                            <th>Wed</th>
                            <th>Thu</th>
                            <th>Fri</th>
                            <th>Sat</th>
                        </tr>
                    </thead>
                    <tbody id="timetableBody">
                        <!-- JS Populated -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
    @media print {

        .sidebar,
        .top-bar,
        .card:not(#timetableContainer .card),
        #viewTimetableForm,
        footer,
        .btn {
            display: none !important;
        }

        .main-wrapper {
            margin: 0;
            padding: 0;
        }

        .content-container {
            padding: 0;
        }

        #timetableContainer {
            display: block !important;
            margin-top: 0 !important;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    const schoolSelect = document.getElementById('username');
    const classSelect = document.getElementById('class_name');
    const semSelect = document.getElementById('semester');
    const findBtn = document.getElementById('findBtn');
    const form = document.getElementById("viewTimetableForm");

    // 1. Initial Load: Fetch Schools
    async function init() {
        try {
            const res = await fetch('/api/schools');
            const schools = await res.json();
            schools.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.username;
                opt.textContent = s.school_name;
                schoolSelect.appendChild(opt);
            });
        } catch (e) { console.error("Error loading schools", e); }
    }
    init();

    // 2. Dependency: School -> Classes
    schoolSelect.addEventListener('change', async () => {
        const username = schoolSelect.value;
        classSelect.innerHTML = '<option value="">Choose Class...</option>';
        semSelect.innerHTML = '<option value="">Choose Sem...</option>';
        classSelect.disabled = true;
        semSelect.disabled = true;
        findBtn.disabled = true;

        if (!username) return;

        try {
            const res = await fetch(`/api/classes?username=${encodeURIComponent(username)}`);
            const classes = await res.json();
            classes.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                classSelect.appendChild(opt);
            });
            classSelect.disabled = false;
        } catch (e) { alert("Error loading classes"); }
    });

    // 3. Dependency: Class -> Semesters
    classSelect.addEventListener('change', async () => {
        const username = schoolSelect.value;
        const className = classSelect.value;
        semSelect.innerHTML = '<option value="">Choose Sem...</option>';
        semSelect.disabled = true;
        findBtn.disabled = true;

        if (!className) return;

        try {
            const res = await fetch(`/api/semesters?username=${encodeURIComponent(username)}&class_name=${encodeURIComponent(className)}`);
            const sems = await res.json();
            sems.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.textContent = `Semester ${s}`;
                semSelect.appendChild(opt);
            });
            semSelect.disabled = false;
        } catch (e) { alert("Error loading semesters"); }
    });

    // 4. Enable Find Button
    semSelect.addEventListener('change', () => {
        findBtn.disabled = !semSelect.value;
    });

    // 5. Submit Handler
    form.addEventListener("submit", function (event) {
        event.preventDefault();

        const btn = findBtn;
        const className = classSelect.value;
        const semester = semSelect.value;
        const username = schoolSelect.value;

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading Schedule...';

        fetch(`/get_timetable?class_name=${encodeURIComponent(className)}&semester=${encodeURIComponent(semester)}&username=${encodeURIComponent(username)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert("âš ï¸ " + data.error);
                    return;
                }

                document.getElementById('resultTitle').innerText = `${className} - Semester ${semester}`;
                let timetableBody = document.getElementById("timetableBody");
                timetableBody.innerHTML = "";

                let visualSlots = data.visual_slots;
                let timetable = data.timetable;
                let days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

                visualSlots.forEach(slot => {
                    let row = document.createElement('tr');

                    if (slot.type === 'break') {
                        row.innerHTML = `
                            <td style="font-weight: 700; background-color: var(--bg-main); border-right: 2px solid var(--border); color: var(--warning); text-align: center;">${slot.time.substring(0, 5)}</td>
                            <td colspan="6" style="background-color: rgba(245, 158, 11, 0.03); text-align: center; font-size: 0.7rem; color: var(--warning); font-weight: 800; letter-spacing: 0.2em;">BREAK PERIOD</td>
                        `;
                    } else {
                        let timeCell = document.createElement('td');
                        timeCell.textContent = slot.time.substring(0, 5);
                        timeCell.style.fontWeight = "600";
                        timeCell.style.background = "var(--bg-main)";
                        timeCell.style.borderRight = "2px solid var(--border)";
                        row.appendChild(timeCell);

                        days.forEach(day => {
                            let cell = document.createElement('td');
                            cell.style.height = "80px";
                            cell.style.padding = "0.4rem";
                            cell.style.verticalAlign = "top";
                            cell.style.borderRight = "1px solid var(--border)";

                            let key = `${day}_${slot.time}`;
                            let subject = timetable[key] || "";
                            if (subject) {
                                cell.innerHTML = `
                                    <div style="padding: 0.5rem; background: rgba(99, 102, 241, 0.08); border-left: 3px solid var(--primary); border-radius: 0.4rem; height: 100%; display: flex; align-items: center; justify-content: center; text-align: center;">
                                        <span style="font-weight: 700; color: var(--primary); font-size: 0.8rem;">${subject}</span>
                                    </div>`;
                            } else {
                                cell.innerHTML = '<div style="height: 100%; display: flex; align-items: center; justify-content: center; opacity: 0.1;"><i class="fas fa-minus" style="font-size: 0.6rem;"></i></div>';
                            }
                            row.appendChild(cell);
                        });
                    }

                    timetableBody.appendChild(row);
                });

                document.getElementById("timetableContainer").style.display = "block";
                document.getElementById("timetableContainer").scrollIntoView({ behavior: 'smooth' });
            })
            .catch(error => {
                console.error(error);
                alert("âš ï¸ Error fetching timetable.");
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-search"></i> Find My Timetable';
            });
    });
</script>
{% endblock %}