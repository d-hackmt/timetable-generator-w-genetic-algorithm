{% extends "layout.html" %}

{% block title %}Modify Timetable - TimetableGen{% endblock %}

{% block breadcrumb %}
<a href="{{ url_for('main.dashboard') }}" style="text-decoration: none; color: var(--text-muted);">Dashboard</a>
<span style="color: var(--text-muted); margin: 0 0.5rem;">/</span>
<a href="{{ url_for('main.generate_setup') }}" style="text-decoration: none; color: var(--text-muted);">Generate</a>
<span style="color: var(--text-muted); margin: 0 0.5rem;">/</span>
<span style="color: var(--text-main); font-weight: 600;">Edit Schedule</span>
{% endblock %}

{% block content %}
<div id="initialChoice" style="max-width: 600px; margin: 4rem auto; text-align: center;">
    <div
        style="width: 80px; height: 80px; background: rgba(99, 102, 241, 0.1); color: var(--primary); border-radius: 2rem; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; margin: 0 auto 2rem auto;">
        <i class="fas fa-edit"></i>
    </div>
    <h1 style="font-family: 'Outfit', sans-serif; font-weight: 700; margin-bottom: 1rem;">Manual Adjustments?</h1>
    <p style="color: var(--text-muted); margin-bottom: 2.5rem;">Would you like to manually tweak the generated schedule
        before finalizing? You can change timeslots and days for each subject.</p>

    <div style="display: flex; gap: 1rem; justify-content: center;">
        <button class="btn btn-primary" style="padding: 1rem 2rem;" onclick="confirmProceed()">
            <i class="fas fa-tools"></i> Yes, Modify Schedule
        </button>
        <button class="btn btn-secondary" style="padding: 1rem 2rem;" onclick="skipModifications()">
            <i class="fas fa-check-double"></i> No, Looks Good
        </button>
    </div>
</div>

<div id="modificationForm" style="display: none;">
    <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 2.5rem;">
        <div>
            <h1 style="font-family: 'Outfit', sans-serif; font-weight: 700; margin-bottom: 0.5rem;">Edit Schedule</h1>
            <p style="color: var(--text-muted);">Rearrange assignments manually. Note: Conflict checking is disabled
                here.</p>
        </div>
        <button type="button" class="btn btn-secondary" onclick="skipModifications()">
            Cancel Changes
        </button>
    </div>

    <form id="modifyForm">
        <div class="card" style="padding: 0; overflow: hidden;">
            <div class="table-container" style="border: none; border-radius: 0; margin-top: 0;">
                <table>
                    <thead>
                        <tr>
                            <th>Subject</th>
                            <th>Day</th>
                            <th>Timeslot</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in timetable %}
                        <tr>
                            <td style="font-weight: 600; color: var(--primary);">
                                <input type="hidden" name="subject[]" value="{{ entry.subject }}">
                                {{ entry.subject }}
                            </td>
                            <td>
                                <select name="day[]" style="margin-bottom: 0;">
                                    {% for day in ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday']
                                    %}
                                    <option value="{{ day }}" {% if entry.day==day %}selected{% endif %}>{{ day }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="timeslot[]" style="margin-bottom: 0;">
                                    {% for slot in timeslots %}
                                    <option value="{{ slot }}" {% if entry.timeslot==slot %}selected{% endif %}>{{
                                        slot[:5] }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div style="display: flex; justify-content: flex-end; margin-top: 2rem;">
            <button type="submit" class="btn btn-primary" id="saveBtn" style="padding: 1rem 3rem;">
                <i class="fas fa-save"></i> Save & View Results
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    function confirmProceed() {
        document.getElementById("initialChoice").style.display = "none";
        document.getElementById("modificationForm").style.display = "block";
    }

    function skipModifications() {
        window.location.href = "{{ url_for('timetable_view.final_timetable') }}";
    }

    document.getElementById("modifyForm").addEventListener("submit", function (event) {
        event.preventDefault();

        const saveBtn = document.getElementById('saveBtn');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

        let timetable = [];
        let rows = document.querySelectorAll("tbody tr");

        rows.forEach(row => {
            let subject = row.querySelector("input[name='subject[]']").value;
            let day = row.querySelector("select[name='day[]']").value;
            let timeslot = row.querySelector("select[name='timeslot[]']").value;

            timetable.push({ subject, day, timeslot });
        });

        fetch("/save_modified_timetable", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ timetable: timetable })
        })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    window.location.href = "{{ url_for('timetable_view.final_timetable') }}";
                } else {
                    alert("⚠️ " + (data.error || "Unknown error"));
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save & View Results';
                }
            })
            .catch(error => {
                alert("⚠️ Error saving timetable.");
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save & View Results';
            });
    });
</script>
{% endblock %}